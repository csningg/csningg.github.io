

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="zningg">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文是对侯捷老师内存管理课程学习记录与总结，原课程见此处,其中本文是对第一节的整理，第一节是关于内存原语~">
<meta property="og:type" content="article">
<meta property="og:title" content="内存原语">
<meta property="og:url" content="https://csningg.github.io/posts/572525303/index.html">
<meta property="og:site_name" content="ning">
<meta property="og:description" content="本文是对侯捷老师内存管理课程学习记录与总结，原课程见此处,其中本文是对第一节的整理，第一节是关于内存原语~">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://csningg.github.io/pictures/20250523/web/9.jpg">
<meta property="article:published_time" content="2025-05-22T14:45:24.000Z">
<meta property="article:modified_time" content="2025-11-21T02:46:03.880Z">
<meta property="article:author" content="zningg">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="基础知识">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://csningg.github.io/pictures/20250523/web/9.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>内存原语 - ning</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/macpanel.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"csningg.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":"https://csningg.github.io/"}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong class="navbar-title">Zning</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="内存原语"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-22 22:45" pubdate>
          2025年5月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          57 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">内存原语</h1>
            
            
              <div class="markdown-body">
                
                <p>本文是对侯捷老师内存管理课程学习记录与总结，原课程见<a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLTcwR9j5y6W2eH37R2_4oEO4Y0tksot56">此处</a>,其中本文是对第一节的整理，第一节是关于内存原语~</p>
<span id="more"></span>
<h1 id="使用内存的方式有哪些">使用内存的方式有哪些？</h1>
<p>在日常的开发环境中，我们都是在应用层进行开发，其直接接触内存的方式有多种。如下图</p>
<figure>
<img src="../pictures/20250522/eda72137-4d4d-4349-9b25-987a8ef9aa16.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<ol type="1">
<li>直接使用标准库，比如STL</li>
<li>使用C++提供的管理内存的方式，比如<code>new</code>，<code>delete</code>，<code>operator new()</code>,<code>operator delete()</code></li>
<li>使用C提供的内存管理方式，<code>malloc/free</code></li>
<li>直接使用OS的API(几乎没)，此种方式和操作会和操作系统及其绑定。</li>
</ol>
<h1 id="c-memory-primitives">C++ memory primitives</h1>
<table>

<thead>
<tr class="header">
<th>分配</th>
<th>释放</th>
<th>归属</th>
<th>是否可重载</th>
<th>单位</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>malloc()</code></td>
<td><code>free()</code></td>
<td>C 函数</td>
<td>不可</td>
<td>byte</td>
</tr>
<tr class="even">
<td><code>new</code></td>
<td><code>delete</code></td>
<td>C++ 表达式(expressions)</td>
<td>不可</td>
<td>object</td>
</tr>
<tr class="odd">
<td><code>::operator new()</code></td>
<td><code>::operator delete()</code></td>
<td>C++ 函数</td>
<td>可</td>
<td>byte</td>
</tr>
<tr class="even">
<td><code>allocator&lt;T&gt;::allocate()</code></td>
<td><code>allocator&lt;T&gt;::deallocate()</code></td>
<td>C++ 标准库</td>
<td>可以自由设计并搭配容器</td>
<td>需要填入T，因此是object</td>
</tr>
</tbody>
</table>
<p>无论是什么方式，在CRT(<strong>C run-time library</strong>)时，基本都是执行的<code>malloc/free</code> ，对于不同的编译器，其allocate函数的接口也有所不同：</p>
<figure>
<img src="../pictures/20250522/image.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>对于GNU C，不同版本又有所不同：</p>
<figure>
<img src="../pictures/20250522/image%201.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>这张图中的<code>gnu_cxx::pool_alloc&lt; T &gt;().allocate()</code>对应于上张图中的<code>allocator&lt; T &gt;().allocate()</code>。</p>
<p>通过<code>malloc</code>和<code>new</code>分配内存、通过<code>free</code>和<code>delete</code>释放内存是十分常用的，通过<code>::operator new</code>操作内存比较少见，<code>allocator</code>分配器操作内存在STL源码中使用较多，对于不同的编译环境使用也有所不同。</p>
<h1 id="基本构件之一-newdelete-expression"><strong>基本构件之一 new/delete expression</strong></h1>
<h2 id="内存申请">1. 内存申请</h2>
<figure>
<img src="../pictures/20250522/image%202.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>上面这张图揭示了new操作背后编译器做的事：</p>
<ul>
<li>1、通过<code>operator new()</code>操作分配一个目标类型的内存大小，这里是<code>Complex</code>的大小；</li>
<li>2、通过<code>static_cast</code>将得到的内存块强制转换为目标类型指针，这里是<code>Complex*</code></li>
<li>3、调用目标类型的构造方法，但是需要注意的是，直接通过<code>pc-&gt;Complex::Complex(1, 2)</code>这样的方法调用构造函数<strong>只有编译器可以做</strong>，用户这样做将产生错误。</li>
</ul>
<p>值得注意的是，<code>operator new()</code>操作的内部是调用了<code>malloc()</code>函数。</p>
<h2 id="内存释放">2. 内存释放</h2>
<figure>
<img src="../pictures/20250522/image%203.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>同样地，<code>delete</code>操作第一步也是调用了对象的析构函数，然后再通过operator delete()函数释放内存，本质上也是调用了<code>free</code>函数。</p>
<h2 id="编译器模拟调用构造函数和析构函数">3. 编译器模拟调用构造函数和析构函数</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-comment">//#include &lt;memory&gt;              //std::allocator  </span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-keyword">namespace</span> jj02<br>&#123;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span><br>    &#123;<br>    <span class="hljs-keyword">public</span>:<br>        <span class="hljs-type">int</span> id;<br><br>        <span class="hljs-built_in">A</span>() : <span class="hljs-built_in">id</span>(<span class="hljs-number">0</span>)      &#123; cout &lt;&lt; <span class="hljs-string">&quot;default ctor. this=&quot;</span> &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; id &lt;&lt; endl; &#125;<br>        <span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> i) : <span class="hljs-built_in">id</span>(i) &#123; cout &lt;&lt; <span class="hljs-string">&quot;ctor. this=&quot;</span> &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; id &lt;&lt; endl; &#125;<br>        ~<span class="hljs-built_in">A</span>()             &#123; cout &lt;&lt; <span class="hljs-string">&quot;dtor. this=&quot;</span> &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; id &lt;&lt; endl; &#125;<br>    &#125;;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_call_ctor_directly</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;\ntest_call_ctor_directly().......... \n&quot;</span>;<br><br>        string* pstr = <span class="hljs-keyword">new</span> string;<br>        cout &lt;&lt; <span class="hljs-string">&quot;str= &quot;</span> &lt;&lt; *pstr &lt;&lt; endl;<br>        <span class="hljs-comment">//! pstr-&gt;string::string(&quot;jjhou&quot;);  </span><br>        <span class="hljs-comment">//[Error] &#x27;class std::basic_string&lt;char&gt;&#x27; has no member named &#x27;string&#x27;</span><br>        <span class="hljs-comment">//! pstr-&gt;~string();    //crash -- 其語法語意都是正確的, crash 只因為上一行被 remark 起來嘛.  </span><br>        cout &lt;&lt; <span class="hljs-string">&quot;str= &quot;</span> &lt;&lt; *pstr &lt;&lt; endl;<br>            <span class="hljs-comment">//------------</span><br><br>        A* pA = <span class="hljs-keyword">new</span> <span class="hljs-built_in">A</span>(<span class="hljs-number">1</span>);           <span class="hljs-comment">//ctor. this=000307A8 id=1</span><br>        cout &lt;&lt; pA-&gt;id &lt;&lt; endl;     <span class="hljs-comment">//1</span><br>        pA-&gt;A::<span class="hljs-built_in">A</span>(<span class="hljs-number">3</span>);<br>        cout &lt;&lt; pA-&gt;id &lt;&lt; endl;<br>        <span class="hljs-comment">//! pA-&gt;A::A(3);                //in VC6 : ctor. this=000307A8 id=3</span><br>        <span class="hljs-comment">//in GCC : [Error] cannot call constructor &#x27;jj02::A::A&#x27; directly</span><br><br>        A::<span class="hljs-built_in">A</span>(<span class="hljs-number">5</span>);<br>        <span class="hljs-comment">//! A::A(5);                    //in VC6 : ctor. this=0013FF60 id=5</span><br>        <span class="hljs-comment">//         dtor. this=0013FF60      </span><br>        <span class="hljs-comment">//in GCC : [Error] cannot call constructor &#x27;jj02::A::A&#x27; directly</span><br>        <span class="hljs-comment">//         [Note] for a function-style cast, remove the redundant &#x27;::A&#x27;</span><br><br>        cout &lt;&lt; pA-&gt;id &lt;&lt; endl;     <span class="hljs-comment">//in VC6 : 3</span><br>        <span class="hljs-comment">//in GCC : 1    </span><br><br>        <span class="hljs-keyword">delete</span> pA;                  <span class="hljs-comment">//dtor. this=000307A8 </span><br><br>        <span class="hljs-comment">//simulate new</span><br>        <span class="hljs-type">void</span>* p = ::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-built_in">sizeof</span>(A));<br>        cout &lt;&lt; <span class="hljs-string">&quot;p=&quot;</span> &lt;&lt; p &lt;&lt; endl;  <span class="hljs-comment">//p=000307A8</span><br>        pA = <span class="hljs-built_in">static_cast</span>&lt;A*&gt;(p);<br>        pA-&gt;A::<span class="hljs-built_in">A</span>(<span class="hljs-number">2</span>);<br>        <span class="hljs-comment">//! pA-&gt;A::A(2);                //in VC6 : ctor. this=000307A8 id=2</span><br>        <span class="hljs-comment">//in GCC : [Error] cannot call constructor &#x27;jj02::A::A&#x27; directly    </span><br><br>        cout &lt;&lt; pA-&gt;id &lt;&lt; endl;     <span class="hljs-comment">//in VC6 : 2</span><br>        <span class="hljs-comment">//in GCC : 0    </span><br><br>        <span class="hljs-comment">//simulate delete</span><br>        pA-&gt;~<span class="hljs-built_in">A</span>();                   <span class="hljs-comment">//dtor. this=000307A8 </span><br>        ::<span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(pA)</span></span>;      <span class="hljs-comment">//free()</span><br>    &#125;<br>&#125; <span class="hljs-comment">//namespace</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    jj02::<span class="hljs-built_in">test_call_ctor_directly</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">215.1</span>.cpp: In function ‘<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">jj02::test_call_ctor_directly</span><span class="hljs-params">()</span>’:</span><br><span class="hljs-function"><span class="hljs-number">215.1</span>.cpp:<span class="hljs-number">33</span>:<span class="hljs-number">16</span>: error: cannot call constructor ‘jj02::A::A’ directly</span><br><span class="hljs-function">   <span class="hljs-number">33</span> |         pA-&gt;A::A(<span class="hljs-number">3</span>);</span><br>      |                ^<br><span class="hljs-number">215.1</span>.cpp:<span class="hljs-number">38</span>:<span class="hljs-number">13</span>: error: cannot call constructor ‘jj02::A::A’ directly [-fpermissive]<br>   <span class="hljs-number">38</span> |         A::<span class="hljs-built_in">A</span>(<span class="hljs-number">5</span>);<br>      |         ~~~~^~~<br><span class="hljs-number">215.1</span>.cpp:<span class="hljs-number">38</span>:<span class="hljs-number">13</span>: note: <span class="hljs-keyword">for</span> a function-style cast, remove the redundant ‘::A’<br><span class="hljs-number">215.1</span>.cpp:<span class="hljs-number">53</span>:<span class="hljs-number">16</span>: error: cannot call constructor ‘jj02::A::A’ directly<br>   <span class="hljs-number">53</span> |         pA-&gt;A::<span class="hljs-built_in">A</span>(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"> <span class="hljs-comment">// 将所有直接调用构造函数的注释掉，在GNU中得到如下</span><br> <span class="hljs-built_in">test_call_ctor_directly</span>().......... <br>str= <br>str= <br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae32b62f0</span> id=<span class="hljs-number">1</span><br><span class="hljs-number">1</span><br><span class="hljs-number">1</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae32b62f0</span> id=<span class="hljs-number">1</span> <span class="hljs-comment">// 调用delete</span><br>p=<span class="hljs-number">0xaaaae32b62f0</span> <span class="hljs-comment">// 调用::operator new()</span><br><span class="hljs-number">-1431424330</span> <span class="hljs-comment">// 由于无法模拟调用构造函数，因此是未知数据</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae32b62f0</span> id=<span class="hljs-number">-1431424330</span> <span class="hljs-comment">// 调用析构函数</span><br></code></pre></td></tr></table></figure>
<p>代码是直接复制的侯捷老师的代码，执行结果如上所示。VS下可以直接通过内存空间调用构造函数，但GNU C下无法通过，具体的内容可见代码注解和打印效果。</p>
<h1 id="基础构件之二-array-newdelete">基础构件之二 Array new/delete</h1>
<figure>
<img src="../pictures/20250522/image%204.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>上图主要展示的是关于<code>new array</code>内存分配的大致情况。当<code>new</code>一个<strong>数组对象</strong>时（例如 <code>new Complex[3]</code>），编译器将分配一块内存，这块内存首部是关于对象内存分配的一些标记，然后下面会分配三个连续的对象内存，在使用<code>delete</code>释放内存时需要使用<code>delete[]</code>。如果不使用<code>delete[]</code>，只是使用<code>delete</code>会根据这块内存的cookies，只会将分配的三块内存空间释放，但不会调用对象的析构函数，如果对象内部还使用了<code>new</code>指向其他空间，如果指向的该空间里的对象的析构函数没有意义（没有申请新的内存），那么不会造成问题，如果有意义（申请了新的内存），那么由于该部分对象析构函数不会调用，那么将会导致内存泄漏。图中<code>new string[3]</code>便是一个例子，虽然<code>str[0]</code>、<code>str[1]</code>、<code>str[2]</code>被析构了，但只是调用了<code>str[0]</code>的析构函数，其他对象的析构函数不被调用，这里就会出问题。</p>
<p>接下来对上述进行代码验证！！！</p>
<figure>
<img src="../pictures/20250522/image%205.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-type">int</span> id;<br>  <br>  <span class="hljs-built_in">A</span>() : <span class="hljs-built_in">id</span>(<span class="hljs-number">0</span>)      &#123; cout &lt;&lt; <span class="hljs-string">&quot;default ctor. this=&quot;</span>  &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; id &lt;&lt; endl;  &#125;<br>  <span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> i) : <span class="hljs-built_in">id</span>(i) &#123; cout &lt;&lt; <span class="hljs-string">&quot;ctor. this=&quot;</span>  &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; id &lt;&lt; endl;  &#125;<br>  ~<span class="hljs-built_in">A</span>()             &#123; cout &lt;&lt; <span class="hljs-string">&quot;dtor. this=&quot;</span>  &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; id &lt;&lt; endl;  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>示例1：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&#123;<br><span class="hljs-comment">//case 1</span><br><span class="hljs-comment">//模拟 memory pool 的作法, array new + placement new. 崩潰 </span><br> <br>    A* buf = (A*)(<span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-built_in">sizeof</span>(A)*size]); <span class="hljs-comment">// 注意这里是new的char</span><br>    A* tmp = buf;   <br>       <br>    cout &lt;&lt; <span class="hljs-string">&quot;buf=&quot;</span> &lt;&lt; buf &lt;&lt; <span class="hljs-string">&quot;  tmp=&quot;</span> &lt;&lt; tmp &lt;&lt; endl;	<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i)<br>        <span class="hljs-keyword">new</span> (tmp++) <span class="hljs-built_in">A</span>(i);  			<span class="hljs-comment">//3次 ctor </span><br><br>    cout &lt;&lt; <span class="hljs-string">&quot;buf=&quot;</span> &lt;&lt; buf &lt;&lt; <span class="hljs-string">&quot;  tmp=&quot;</span> &lt;&lt; tmp &lt;&lt; endl;<br>            <br>    <span class="hljs-comment">//!	delete [] buf;    	//crash. why?</span><br>                        <span class="hljs-comment">//因为new的是一个 char array，编译器看到 delete [] buf; 编译器企图调用多次 A::~A. </span><br>                        <span class="hljs-comment">// 但 array memory layout 中找不到与 array 元素个数 (本例 3) 相关的信息, </span><br>                        <span class="hljs-comment">// -- 整个内存布局都乱掉，於是崩潰。 </span><br>    <span class="hljs-keyword">delete</span> buf;     	<span class="hljs-comment">//dtor just one time, ~[0]	</span><br><br>    cout &lt;&lt; <span class="hljs-string">&quot;\n\n&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 调用delete buf</span><br><span class="hljs-built_in">test_placement_new</span>()..........<br>buf=<span class="hljs-number">0xaaaae6feb2c0</span>  tmp=<span class="hljs-number">0xaaaae6feb2c0</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae6feb2c0</span> id=<span class="hljs-number">0</span> <span class="hljs-comment">// 相差4个字节是因为类A的大小是4个字节</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae6feb2c4</span> id=<span class="hljs-number">1</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae6feb2c8</span> id=<span class="hljs-number">2</span><br>buf=<span class="hljs-number">0xaaaae6feb2c0</span>  tmp=<span class="hljs-number">0xaaaae6feb2cc</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae6feb2c0</span> id=<span class="hljs-number">0</span> <span class="hljs-comment">// 只调用了第一个元素的构造函数</span><br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 调用delete [] buf</span><br><span class="hljs-built_in">test_placement_new</span>()..........<br>buf=<span class="hljs-number">0xaaaace26f2c0</span>  tmp=<span class="hljs-number">0xaaaace26f2c0</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2c0</span> id=<span class="hljs-number">0</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2c4</span> id=<span class="hljs-number">1</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2c8</span> id=<span class="hljs-number">2</span><br>buf=<span class="hljs-number">0xaaaace26f2c0</span>  tmp=<span class="hljs-number">0xaaaace26f2cc</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f340</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f33c</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f338</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f334</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f330</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f32c</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f328</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f324</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f320</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f31c</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f318</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f314</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f310</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f30c</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f308</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f304</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f300</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2fc</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2f8</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2f4</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2f0</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2ec</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2e8</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2e4</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2e0</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2dc</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2d8</span> id=<span class="hljs-number">60721</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2d4</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2d0</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2cc</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2c8</span> id=<span class="hljs-number">2</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2c4</span> id=<span class="hljs-number">1</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaace26f2c0</span> id=<span class="hljs-number">0</span><br><span class="hljs-built_in">free</span>(): invalid pointer<br>[<span class="hljs-number">1</span>]    <span class="hljs-number">1773946</span> <span class="hljs-built_in">abort</span> (core dumped)  ./a<br></code></pre></td></tr></table></figure>
<p>示例二：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&#123;<br><span class="hljs-comment">//case 2</span><br><span class="hljs-comment">// test array new</span><br>    A* buf = <span class="hljs-keyword">new</span> A[size];  <span class="hljs-comment">//default ctor 3 次. [0]先于[1]先于[2])</span><br>             <span class="hljs-comment">//A有 default ctor, 否则 [Error] no matching function for call to &#x27;jj02::A::A()&#x27;</span><br>    A* tmp = buf;   <br>       <br>    cout &lt;&lt; <span class="hljs-string">&quot;buf=&quot;</span> &lt;&lt; buf &lt;&lt; <span class="hljs-string">&quot;  tmp=&quot;</span> &lt;&lt; tmp &lt;&lt; endl;	<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i)<br>        <span class="hljs-keyword">new</span> (tmp++) <span class="hljs-built_in">A</span>(i);  		<span class="hljs-comment">//3次 ctor </span><br><br>    cout &lt;&lt; <span class="hljs-string">&quot;buf=&quot;</span> &lt;&lt; buf &lt;&lt; <span class="hljs-string">&quot;  tmp=&quot;</span> &lt;&lt; tmp &lt;&lt; endl;<br>            <br>    <span class="hljs-keyword">delete</span> [] buf;    <span class="hljs-comment">//dtor three times (次序逆反, [2]先于[1]先于[0])	</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">test_placement_new</span>()..........<br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442c8</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442cc</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442d0</span> id=<span class="hljs-number">0</span><br>buf=<span class="hljs-number">0xaaaaee7442c8</span>  tmp=<span class="hljs-number">0xaaaaee7442c8</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442c8</span> id=<span class="hljs-number">0</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442cc</span> id=<span class="hljs-number">1</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442d0</span> id=<span class="hljs-number">2</span><br>buf=<span class="hljs-number">0xaaaaee7442c8</span>  tmp=<span class="hljs-number">0xaaaaee7442d4</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442d0</span> id=<span class="hljs-number">2</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442cc</span> id=<span class="hljs-number">1</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaee7442c8</span> id=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>构造函数调用顺序是按照构建对象顺序来执行的，但是析构函数执行却相反。值得注意的是，在调用了<code>delete</code>的case1的代码段中，数组有三个元素，但最后只调用了第一个对象的析构函数。</p>
<p>接下来将更具体地展示new array对象的内存分配情况：</p>
<figure>
<img src="../pictures/20250522/image%206.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>如果使用<code>new</code>分配十个内存的<code>int</code>，内存空间如上图所示，首先内存块会有一个头和尾，黄色部分为debug信息，灰色部分才是真正使用到的内存，蓝色部分的12 bytes是为了让该内存块以16字节对齐。在这个例子中<code>delete pi</code>和<code>delete[] pi</code>效果是一样的，因为<code>int</code>没有析构函数。但是下面的例子就不一样了：</p>
<figure>
<img src="../pictures/20250522/image%207.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>上图通过<code>new</code>申请三个<code>Demo</code>空间大小，内存块使用了96 byte，这里是这样计算得到的：黄色部分调试信息32 + 4 = 36 byte；黄色部分下面的“3”用于标记实际分配给对象内存个数，这里是三个所以里面内容为3，消耗4 byte；<code>Demo</code>内有三个<code>int</code>类型成员变量，一个<code>Demo</code>消耗内存3 * 4 = 12 byte，由于有三个<code>Demo</code>，所以消耗了12 * 3 = 36 <code>byte</code>空间；到目前为止消耗36 + 4 + 36 = 76 byte，加上头尾<code>cookie</code>一共8 <code>byte</code>一共消耗84 <code>byte</code>，由于需要16位对齐，所以填充蓝色部分为12 byte，一共消耗了84 + 12 = 96 <code>byte</code>。这里释放内存时需要加上<code>delete[]</code>，上面分配内存中有个标记“3”，所以编译器将释放三个Demo对象空间，如果不加就会报错。</p>
<p>因为在内存的布局中了多了个3，是因为构造函数是<code>no-trivial</code>的。整个内存布局就不同了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-type">int</span> x, y, z; <span class="hljs-comment">// 假设有三个int成员变量</span><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Demo</span>() &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Constructor called&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-comment">// ~Demo() &#123;</span><br>    <span class="hljs-comment">//     std::cout &lt;&lt; &quot;Destructor called&quot; &lt;&lt; std::endl;</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    Demo* p = <span class="hljs-keyword">new</span> Demo[<span class="hljs-number">3</span>];<br>    <span class="hljs-keyword">delete</span> p;<br>&#125;<br>Constructor called<br>Constructor called<br>Constructor called<br></code></pre></td></tr></table></figure>
<p>假如析构函数是<code>no-trivial</code>，即把注释去掉，就必须调用<code>delete []</code>，否则会出现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">a.cpp: In function ‘<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>’:</span><br><span class="hljs-function">a.cpp:<span class="hljs-number">88</span>:<span class="hljs-number">12</span>: warning: ‘void operator delete(void*, std::size_t)’ called on pointer ‘&lt;unknown&gt;’ with nonzero offset <span class="hljs-number">8</span> [-Wfree-nonheap-object]</span><br><span class="hljs-function">   <span class="hljs-number">88</span> |     delete p;</span><br>      |            ^<br>a.cpp:<span class="hljs-number">87</span>:<span class="hljs-number">25</span>: note: returned from ‘<span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span> [](std::<span class="hljs-type">size_t</span>)’<br>   <span class="hljs-number">87</span> |     Demo* p = <span class="hljs-keyword">new</span> Demo[<span class="hljs-number">3</span>];<br><br><span class="hljs-function">Constructor called</span><br><span class="hljs-function">Constructor called</span><br><span class="hljs-function">Constructor called</span><br><span class="hljs-function">Destructor called</span><br><span class="hljs-function"><span class="hljs-title">munmap_chunk</span><span class="hljs-params">()</span>: invalid pointer</span><br><span class="hljs-function">[<span class="hljs-number">1</span>]    <span class="hljs-number">1779694</span> abort (core dumped)  ./a</span><br></code></pre></td></tr></table></figure>
<h1 id="基础构件之三-placement-newdelete">基础构件之三 placement new/delete</h1>
<figure>
<img src="../pictures/20250522/image%208.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<h1 id="基本构件之分配流程">基本构件之分配流程</h1>
<figure>
<img src="../pictures/20250522/image%209.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>在应用程序调用<code>new</code>和<code>delete</code>之后，编译器会调用<code>operator new/delete</code>，在正常的情况下，是调用全局的<code>operator new/delete</code>，走第二条路线，但是如果类中有重载<code>operator new/delete</code>时，会走第一条路线。注意<code>new expression</code>（即第一层<code>new</code>）是不可改变不可重载的。正式因为可以重做类中的<code>operator new/delete</code>，程序员才有机会将内存管理接管过来，做更细致和高效的内存管理。</p>
<aside>
<p>💡 我们的目标是把第二条线路接管过来，走第一条线路。如此，我们就可以做类的内存管理了</p>
</aside>
<figure>
<img src="../pictures/20250522/image%2010.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>对于GNU C，背后使用的<code>allocate()</code>函数最后也是调用了系统的<code>::operator new()</code>函数。</p>
<h1 id="基本构件之重载">基本构件之重载</h1>
<figure>
<img src="../pictures/20250522/image%2011.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>上面这张图演示了如何重载系统的<code>::operator new()</code>函数，该方法最后也是模拟了系统的做法，效果和系统的方法一样，但一般不推荐重载<code>::operator new()</code>函数，因为它对全局有影响，如果使用不当将造成很大的问题。</p>
<p>如果是在类中重载<code>operator new()</code>方法，那么该方法有N多种形式，但必须保证函数参数列表第一个参数是<code>size_t</code>类型变量；对于<code>operator delete()</code>，第一个参数必须是<code>void*</code> 类型，第二个<code>size_t</code>是可选项，可以去掉。</p>
<figure>
<img src="../pictures/20250522/image%2012.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>对于<code>operator new[]</code>和<code>operator delete[]</code>函数的重载，和前面类似。</p>
<figure>
<img src="../pictures/20250522/image%2013.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2014.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2015.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2016.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>代码如下，在下面代码中，尽管重载了operator new，operator delete等。但是在底层还是用的malloc和free，只是加了些打印的信息。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-type">int</span> _id; <span class="hljs-comment">// 4 bytes</span><br>  <span class="hljs-type">long</span> _data; <span class="hljs-comment">// 8 bytes</span><br>  string _str; <span class="hljs-comment">// 32 bytes</span><br>  <br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>  <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* deadObject, <span class="hljs-type">size_t</span> size)</span></span>;<br>    <span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span> size);<br>    <span class="hljs-type">static</span> <span class="hljs-type">void</span>  <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>* deadObject, <span class="hljs-type">size_t</span> size);	  	  <br>  <br>  <span class="hljs-built_in">Foo</span>() : _id(<span class="hljs-number">0</span>)      &#123; cout &lt;&lt; <span class="hljs-string">&quot;default ctor. this=&quot;</span>  &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; _id &lt;&lt; endl;  &#125;<br>  <span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span> i) : _id(i) &#123; cout &lt;&lt; <span class="hljs-string">&quot;ctor. this=&quot;</span>  &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; _id &lt;&lt; endl;  &#125;<br>  <span class="hljs-comment">//virtual </span><br>  ~<span class="hljs-built_in">Foo</span>()              &#123; cout &lt;&lt; <span class="hljs-string">&quot;dtor. this=&quot;</span>  &lt;&lt; <span class="hljs-keyword">this</span> &lt;&lt; <span class="hljs-string">&quot; id=&quot;</span> &lt;&lt; _id &lt;&lt; endl;  &#125;<br>  <br>  <span class="hljs-comment">//不加 virtual dtor, sizeof = 48, new Foo[5] =&gt; operator new[]() 的 size 参数是 64, </span><br>  <span class="hljs-comment">//加了 virtual dtor, sizeof = 56, new Foo[5] =&gt; operator new[]() 的 size 参数是 84, </span><br>  <span class="hljs-comment">//上述二例，多出來的 4 可能就是個 size_t 欄位用來放置 array size. </span><br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span>* Foo::<span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    Foo* p = (Foo*)<span class="hljs-built_in">malloc</span>(size);  <br>    cout &lt;&lt; <span class="hljs-string">&quot;Foo::operator new(), size=&quot;</span> &lt;&lt; size &lt;&lt; <span class="hljs-string">&quot;\t  return: &quot;</span> &lt;&lt; p &lt;&lt; endl;  	<br><br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> Foo::<span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* pdead, <span class="hljs-type">size_t</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;Foo::operator delete(), pdead= &quot;</span> &lt;&lt; pdead &lt;&lt; <span class="hljs-string">&quot;  size= &quot;</span> &lt;&lt; size &lt;&lt; endl;<br>    <span class="hljs-built_in">free</span>(pdead);<br>&#125;<br><br><span class="hljs-type">void</span>* Foo::<span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span> size)<br>&#123;<br>    Foo* p = (Foo*)<span class="hljs-built_in">malloc</span>(size);  <span class="hljs-comment">//crash, 問題可能出在這兒 </span><br>    cout &lt;&lt; <span class="hljs-string">&quot;Foo::operator new[](), size=&quot;</span> &lt;&lt; size &lt;&lt; <span class="hljs-string">&quot;\t  return: &quot;</span> &lt;&lt; p &lt;&lt; endl;  <br>    <br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br><br><span class="hljs-type">void</span> Foo::<span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>* pdead, <span class="hljs-type">size_t</span> size)<br>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;Foo::operator delete[](), pdead= &quot;</span> &lt;&lt; pdead &lt;&lt; <span class="hljs-string">&quot;  size= &quot;</span> &lt;&lt; size &lt;&lt; endl;<br>    <br>    <span class="hljs-built_in">free</span>(pdead);<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 测试语句</span><br>&#123;<br>Foo* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>(<span class="hljs-number">7</span>);<br><span class="hljs-keyword">delete</span> p;<br><br>Foo* pArray = <span class="hljs-keyword">new</span> Foo[<span class="hljs-number">5</span>];	<span class="hljs-comment">//無法給 array elements 以 initializer</span><br><span class="hljs-keyword">delete</span> [] pArray;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">test_overload_operator_new_and_array_new</span>()..........<br><span class="hljs-built_in">sizeof</span>(Foo)= <span class="hljs-number">56</span><br>Foo::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(), size=<span class="hljs-number">56</span>	  <span class="hljs-keyword">return</span>: <span class="hljs-number">0xaaaaf47622c0</span><br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf47622c0</span> id=<span class="hljs-number">7</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf47622c0</span> id=<span class="hljs-number">7</span><br>Foo::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">delete</span>(), pdead= <span class="hljs-number">0xaaaaf47622c0</span>  size= <span class="hljs-number">56</span><br>Foo::<span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](), size=<span class="hljs-number">288</span>	  <span class="hljs-keyword">return</span>: <span class="hljs-number">0xaaaaf4762300</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf4762308</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf4762340</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf4762378</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf47623b0</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf47623e8</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf47623e8</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf47623b0</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf4762378</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf4762340</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaaf4762308</span> id=<span class="hljs-number">0</span><br>Foo::<span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](), pdead= <span class="hljs-number">0xaaaaf4762300</span>  size= <span class="hljs-number">288</span><br></code></pre></td></tr></table></figure>
<p>分析：当执行<code>Foo* p = new Foo(7);</code>时，编译器会调用类重载的<code>void* Foo::operator new(size_t size)</code>函数，其中参数<code>size_t</code>会自动识别为类的大小56，然后调用类的构造函数，传入的参数为7，而后执行delete p;时，会先调用类的析构函数，然后执行调用类重载的<code>void Foo::operator delete(void* pdead, size_t size)，</code>参数为自动传入的，大小也为类的大小56</p>
<p>当执行<code>Foo* pArray = new Foo[5];</code>，编辑器会自动调用<code>void* Foo::operator new[](size_t size)</code>，然后传入的<code>size_t</code>是288，这个参数也是自动传入的。然后调用5次类的构造函数。执行<code>void Foo::operator delete[](void* pdead, size_t size)</code>，按逆序自动调用类的析构函数后，然后调用类重载的<code>void Foo::operator delete[](void* pdead, size_t size)</code>，参数也是自动传入的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br>&#123;	    <br>cout &lt;&lt; <span class="hljs-string">&quot;testing global expression ::new and ::new[] \n&quot;</span>;<br><span class="hljs-comment">// 這會繞過 overloaded new(), delete(), new[](), delete[]() </span><br><span class="hljs-comment">// 但當然 ctor, dtor 都會被正常呼叫.  </span><br><br>Foo* p = ::<span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>(<span class="hljs-number">7</span>);<br>::<span class="hljs-keyword">delete</span> p;<br><br>Foo* pArray = ::<span class="hljs-keyword">new</span> Foo[<span class="hljs-number">5</span>];	<br>::<span class="hljs-keyword">delete</span> [] pArray;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">test_overload_operator_new_and_array_new</span>()..........<br><span class="hljs-built_in">sizeof</span>(Foo)= <span class="hljs-number">48</span><br>testing global expression ::<span class="hljs-keyword">new</span> <span class="hljs-keyword">and</span> ::<span class="hljs-keyword">new</span>[]<br>ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d092c0</span> id=<span class="hljs-number">7</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d092c0</span> id=<span class="hljs-number">7</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09308</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09338</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09368</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09398</span> id=<span class="hljs-number">0</span><br><span class="hljs-keyword">default</span> ctor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d093c8</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d093c8</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09398</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09368</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09338</span> id=<span class="hljs-number">0</span><br>dtor. <span class="hljs-keyword">this</span>=<span class="hljs-number">0xaaaae8d09308</span> id=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>当使用全局的<code>new</code>和<code>delete</code>时，会跳过重载的函数。</p>
<figure>
<img src="../pictures/20250522/image%2017.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<ol type="1">
<li><strong>重载 <code>operator new()</code></strong>：
<ul>
<li>可以为类定义多个版本的 <code>operator new()</code>。</li>
<li>每个版本必须有独特的参数列表，其中第一个参数必须是 <code>size_t</code>，因为<code>Foo</code>的大小会被传入函数里面，所以第一个必须为<code>size_t</code>于接受类型的大小。</li>
<li>额外参数称为 placement arguments，可以在 <code>new</code> 表达式中传递。</li>
<li>示例：<code>Foo* pf = new (300, 'c') Foo;</code> 使用了 placement new。</li>
</ul></li>
<li><strong>重载 <code>operator delete()</code></strong>：
<ul>
<li>也可以为类定义多个版本的 <code>operator delete()</code>。</li>
<li>这些版本不会被常规的 <code>delete</code> 调用。</li>
<li>只有当 <code>new</code> 所调用的构造函数抛出异常时，才会调用这些重载的 <code>operator delete()</code>。原因是在C++中，如果<code>new</code>完数据后，构造函数构造失败，需要能够<code>delete</code>掉内存。主要用于处理未能成功构造对象时释放内存。</li>
</ul></li>
</ol>
<p>示例：</p>
<figure>
<img src="../pictures/20250522/image%2018.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2019.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-keyword">namespace</span> jj07<br>&#123;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Bad</span> &#123; &#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Foo</span>() &#123; cout &lt;&lt; <span class="hljs-string">&quot;Foo::Foo()&quot;</span> &lt;&lt; endl;  &#125;<br>    <span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span>) &#123; <br>                cout &lt;&lt; <span class="hljs-string">&quot;Foo::Foo(int)&quot;</span> &lt;&lt; endl;  <br>                <span class="hljs-comment">// throw Bad();  </span><br>             &#125;<br><br>    <span class="hljs-comment">//(1) 这个就是一般的 operator new() 的重载</span><br>    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;operator new(size_t size), size= &quot;</span> &lt;&lt; size &lt;&lt; endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">malloc</span>(size);  <br>    &#125;<br><br>    <span class="hljs-comment">//(2) 这个就是标准库已经提供的 placement new() 的重载 (形式)</span><br>    <span class="hljs-comment">//    (所以我也模拟 standard placement new 的动作, just return ptr) </span><br>    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* start)</span> </span>&#123; <br>        cout &lt;&lt; <span class="hljs-string">&quot;operator new(size_t size, void* start), size= &quot;</span> &lt;&lt; size &lt;&lt; <span class="hljs-string">&quot;  start= &quot;</span> &lt;&lt; start &lt;&lt; endl;<br>        <span class="hljs-keyword">return</span> start;<br>    &#125;<br><br>    <span class="hljs-comment">//(3) 这个才是崭新的 placement new </span><br>    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">long</span> extra)</span> </span>&#123; <br>        cout &lt;&lt; <span class="hljs-string">&quot;operator new(size_t size, long extra)  &quot;</span> &lt;&lt; size &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; extra &lt;&lt; endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">malloc</span>(size+extra);<br>    &#125;<br><br>    <span class="hljs-comment">//(4) 這又是一个 placement new </span><br>    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">long</span> extra, <span class="hljs-type">char</span> init)</span> </span>&#123; <br>        cout &lt;&lt; <span class="hljs-string">&quot;operator new(size_t size, long extra, char init)  &quot;</span> &lt;&lt; size &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; extra &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; init &lt;&lt; endl;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">malloc</span>(size+extra);<br>    &#125;<br>    <br>    <span class="hljs-comment">//(5) 這又是一個 placement new, 但故意寫錯第一參數的 type (它必須是 size_t 以滿足正常的 operator new) </span><br><span class="hljs-comment">//!  	void* operator new(long extra, char init) &#123; //[Error] &#x27;operator new&#x27; takes type &#x27;size_t&#x27; (&#x27;unsigned int&#x27;) as first parameter [-fpermissive]</span><br><span class="hljs-comment">//!	  	cout &lt;&lt; &quot;op-new(long,char)&quot; &lt;&lt; endl;</span><br><span class="hljs-comment">//!    	return malloc(extra);</span><br><span class="hljs-comment">//!  	&#125; 	</span><br><br>    <span class="hljs-comment">//以下是搭配上述 placement new 的各個 called placement delete. </span><br>    <span class="hljs-comment">//當 ctor 發出異常，這兒對應的 operator (placement) delete 就會被喚起. </span><br>    <span class="hljs-comment">//應該是要負責釋放其搭檔兄弟 (placement new) 分配所得的 memory.  </span><br>    <span class="hljs-comment">//(1) 這個就是一般的 operator delete() 的重载 </span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*,<span class="hljs-type">size_t</span>)</span></span><br><span class="hljs-function">    </span>&#123; cout &lt;&lt; <span class="hljs-string">&quot;operator delete(void*,size_t)  &quot;</span> &lt;&lt; endl;  &#125;<br><br>    <span class="hljs-comment">//(2) 这是对上述的 (2)  </span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*,<span class="hljs-type">void</span>*)</span></span><br><span class="hljs-function">    </span>&#123; cout &lt;&lt; <span class="hljs-string">&quot;operator delete(void*,void*)  &quot;</span> &lt;&lt; endl;  &#125;<br><br>    <span class="hljs-comment">//(3) 这是对上述的 (3)  </span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*,<span class="hljs-type">long</span>)</span></span><br><span class="hljs-function">    </span>&#123; cout &lt;&lt; <span class="hljs-string">&quot;operator delete(void*,long)  &quot;</span> &lt;&lt; endl;  &#125;<br><br>    <span class="hljs-comment">//(4) 這是对上述的 (4)  </span><br>    <span class="hljs-comment">//如果沒有一一对应, 也不會有任何编译报错</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*,<span class="hljs-type">long</span>,<span class="hljs-type">char</span>)</span></span><br><span class="hljs-function">    </span>&#123; cout &lt;&lt; <span class="hljs-string">&quot;operator delete(void*,long,char)  &quot;</span> &lt;&lt; endl; &#125;<br>    <br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> m_i;<br>&#125;;<br><br><span class="hljs-comment">//-------------	</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_overload_placement_new</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;\n\n\ntest_overload_placement_new().......... \n&quot;</span>;<br>    <br>    Foo start;  <span class="hljs-comment">//Foo::Foo</span><br><br>    Foo* p1 = <span class="hljs-keyword">new</span> Foo;           <span class="hljs-comment">//op-new(size_t)</span><br>    Foo* p2 = <span class="hljs-built_in">new</span> (&amp;start) Foo;  <span class="hljs-comment">//op-new(size_t,void*)</span><br>    Foo* p3 = <span class="hljs-built_in">new</span> (<span class="hljs-number">100</span>) Foo;     <span class="hljs-comment">//op-new(size_t,long)</span><br>    Foo* p4 = <span class="hljs-built_in">new</span> (<span class="hljs-number">100</span>,<span class="hljs-string">&#x27;a&#x27;</span>) Foo; <span class="hljs-comment">//op-new(size_t,long,char)</span><br><br>    Foo* p5 = <span class="hljs-built_in">new</span> (<span class="hljs-number">100</span>) <span class="hljs-built_in">Foo</span>(<span class="hljs-number">1</span>);     <span class="hljs-comment">//op-new(size_t,long)  op-del(void*,long)</span><br>    Foo* p6 = <span class="hljs-built_in">new</span> (<span class="hljs-number">100</span>,<span class="hljs-string">&#x27;a&#x27;</span>) <span class="hljs-built_in">Foo</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">//</span><br>    Foo* p7 = <span class="hljs-built_in">new</span> (&amp;start) <span class="hljs-built_in">Foo</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">//</span><br>    Foo* p8 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>(<span class="hljs-number">1</span>);           <span class="hljs-comment">//</span><br>    <span class="hljs-comment">//VC6 warning C4291: &#x27;void *__cdecl Foo::operator new(unsigned int)&#x27;</span><br>    <span class="hljs-comment">//no matching operator delete found; memory will not be freed if</span><br>    <span class="hljs-comment">//initialization throws an exception</span><br>&#125;<br>&#125; <span class="hljs-comment">//namespace	</span><br><span class="hljs-comment">//----------------------------------------------------</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    jj07::<span class="hljs-built_in">test_overload_placement_new</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">test_overload_placement_new</span>()..........<br>Foo::<span class="hljs-built_in">Foo</span>()<br><span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>, size</span>= <span class="hljs-number">4</span><br>Foo::<span class="hljs-built_in">Foo</span>()<br><span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* start)</span>, size</span>= <span class="hljs-number">4</span>  start= <span class="hljs-number">0xffffcd958430</span><br>Foo::<span class="hljs-built_in">Foo</span>()<br><span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-type">size_t</span> size, <span class="hljs-type">long</span> extra)  <span class="hljs-number">4</span> <span class="hljs-number">100</span><br>Foo::<span class="hljs-built_in">Foo</span>()<br><span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-type">size_t</span> size, <span class="hljs-type">long</span> extra, <span class="hljs-type">char</span> init)  <span class="hljs-number">4</span> <span class="hljs-number">100</span> a<br>Foo::<span class="hljs-built_in">Foo</span>()<br><span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-type">size_t</span> size, <span class="hljs-type">long</span> extra)  <span class="hljs-number">4</span> <span class="hljs-number">100</span><br>Foo::<span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span>)<br><span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-type">size_t</span> size, <span class="hljs-type">long</span> extra, <span class="hljs-type">char</span> init)  <span class="hljs-number">4</span> <span class="hljs-number">100</span> a<br>Foo::<span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span>)<br><span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* start), size= <span class="hljs-number">4</span>  start= <span class="hljs-number">0xffffcd958430</span><br>Foo::<span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span>)<br><span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-type">size_t</span> size), size= <span class="hljs-number">4</span><br>Foo::<span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span>)<br></code></pre></td></tr></table></figure>
<p>在进行重载new()，delete()，第一个参数默认是的size_t，是不能改变的，改变就会错误。在进行函数定义时必须要这么定义，否则就会出错。</p>
<p>在进行函数调用时，第一个参数是默认传入对象的大小，这个是不用写，我们只需要填写从第二个开始的函数即可。</p>
<figure>
<img src="../pictures/20250522/image%2020.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>C++中使用 <code>new(extra)</code> 来动态分配（即“扩充申请”）<code>basic_string</code>对象的内容</p>
<ol type="1">
<li><strong><code>basic_string</code> 类的定义：</strong>
<ul>
<li>这是C++标准库中字符串类的基础模板，支持自定义字符类型（如 <code>char</code>、<code>wchar_t</code> 等）。</li>
<li>它内部有一个私有成员 <code>Rep</code>，代表字符串的存储结构（通常包括指针、长度、容量等信息）。</li>
</ul></li>
<li><strong><code>new(extra)</code> 的作用：</strong>
<ul>
<li>在传统的 <code>new</code> 操作中，动态分配一块内存用来存放对象。</li>
<li><code>new(extra)</code> 是一种“扩展”用法，允许在分配的同时为对象预留额外空间（这里指 <code>extra</code> 字节），以便存放额外数据或优化存储。</li>
</ul></li>
</ol>
<h1 id="per-class-allocator-版本一">Per-class allocator 版本一</h1>
<figure>
<img src="../pictures/20250522/image%2021.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>类的内存分配器有两个作用，一是降低<code>malloc</code>的调用次数，二是减少每次调用<code>malloc</code>都会产生的<code>cookies</code>，因此我们希望对类设计一个分配器，我可以一次性申请24个类的大小，每次需要时都可以从已经分配好的内存池中获取。针对以上的设计目的，类可以设计成如上的版本。</p>
<p>对于每一个类都有一个<code>next</code>指针，指向下一个块，另外对于此类还需要一个<code>freeStore</code>来存储整个空闲块的位置。</p>
<p>对于类中<code>operator new的</code>设计，我们已经知道，<code>operator new</code>的第一个参数是类的大小，<code>freeStore</code>是申请的字节的大小，然后又将其转成了<code>Screen</code>类型，当把指针的类型转成<code>Screen</code>类型时，每次对指针的<code>++</code>编译器都会将其转换成对类型大小的操作。</p>
<p>在<code>operator delete</code>时，需要传入指针的位置以及大小，大小是我们已知的，因此是无用的，归还时直接将其插入到队列的最前端。</p>
<p>对应的测试代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Screen</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Screen</span>(<span class="hljs-type">int</span> x) : <span class="hljs-built_in">i</span>(x) &#123;&#125;;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> i;&#125;<br>    <span class="hljs-comment">// 重载的operator new和delete的size_t的大小默认是类的大小</span><br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span>)</span></span>;<br>    <span class="hljs-comment">// static void operator delete(void*, size_t);</span><br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>*)</span></span>; <span class="hljs-comment">// 只能任选一个，但是两者不能共存</span><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-comment">// 内存管理数据结构</span><br>    Screen* next;<br>    <span class="hljs-type">static</span> Screen* freeStore;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> screenChunk;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> i;<br>&#125;;<br><br><span class="hljs-comment">// 静态成员变量在类外初始化</span><br>Screen* Screen::freeStore = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> Screen::screenChunk = <span class="hljs-number">24</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span>* Screen::<span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    Screen* p = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">if</span> (!freeStore) &#123;<br>        <span class="hljs-comment">// 刚开始linklist是空，所以取一大块的memory</span><br>        <span class="hljs-comment">// 接下来是调用全局的 operator new</span><br>        <span class="hljs-type">size_t</span> chunk = screenChunk * size;<br>        freeStore = p =<br>            <span class="hljs-built_in">reinterpret_cast</span>&lt;Screen*&gt;(<span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[chunk]);<br>        <span class="hljs-comment">// 现在内存已经分配还了，需要把其链接起来</span><br>        <span class="hljs-keyword">for</span> (; p != &amp;freeStore[screenChunk - <span class="hljs-number">1</span>]; ++p) &#123;<br>            p-&gt;next = p + <span class="hljs-number">1</span>;<br>        &#125;<br>        p-&gt;next = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    p = freeStore;<br>    freeStore = freeStore-&gt;next;<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> Screen::<span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span> </span>&#123;<br>    (<span class="hljs-built_in">static_cast</span>&lt;Screen*&gt;(p))-&gt;next = freeStore;<br>    freeStore = <span class="hljs-built_in">static_cast</span>&lt;Screen*&gt;(p);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;test per class allocator 1.....&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;sizeof(Screen) = &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(Screen) &lt;&lt; endl;<br><br>    <span class="hljs-type">size_t</span> <span class="hljs-type">const</span> N = <span class="hljs-number">100</span>;<br>    Screen* p[N];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) &#123;<br>        p[i] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Screen</span>(i);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>        cout &lt;&lt; p[i] &lt;&lt; endl;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) &#123;<br>        <span class="hljs-keyword">delete</span> p[i];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp">test per <span class="hljs-keyword">class</span> <span class="hljs-title class_">allocator</span> <span class="hljs-number">1.</span>....<br><span class="hljs-built_in">sizeof</span>(Screen) = <span class="hljs-number">16</span><br><span class="hljs-number">0xaaaac8b402c0</span><br><span class="hljs-number">0xaaaac8b402d0</span><br><span class="hljs-number">0xaaaac8b402e0</span><br><span class="hljs-number">0xaaaac8b402f0</span><br><span class="hljs-number">0xaaaac8b40300</span><br><span class="hljs-number">0xaaaac8b40310</span><br><span class="hljs-number">0xaaaac8b40320</span><br><span class="hljs-number">0xaaaac8b40330</span><br><span class="hljs-number">0xaaaac8b40340</span><br><span class="hljs-number">0xaaaac8b40350</span><br></code></pre></td></tr></table></figure>
<p>由测试结果可见，我们确实已经把内存接管过来了，因为分配的几个<code>Screen</code>是连续的，<code>Screen</code>之间是只相差了16个字节，与类的大小保持一致，上下并没有<code>cookies</code>，符合预期。</p>
<p>但是这样做好像是有些浪费资源，因为在类中额外定义了<code>Screen*</code>的<code>next</code>指针，浪费了4个字节。如果<code>new</code>的数目足够的大，那么此部分的消耗也是不可忽略的。因此引出了接下来的版本2，不再额外定义<code>Screen*</code>的<code>next</code>指针。</p>
<h1 id="per-class-allocator-版本二">Per-class allocator 版本二</h1>
<figure>
<img src="../pictures/20250522/image%2022.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<ul>
<li>设计<code>per-class allocator 2</code>的目的，是为了避免在每个对象中都额外存储一个<code>next</code>指针，节省空间。</li>
<li>为此，采用<strong>联合体（<code>union</code>）</strong>，让内存块在空闲时可以用作链表的<code>next</code>指针。</li>
<li><strong>当这块内存未被使用（空闲）时</strong>，前四个字节（或最开始的部分）用来存放<code>next</code>指针。</li>
<li><strong>当这块内存被使用（分配给对象）时</strong>，它就占用整个块，用于存放对象数据。</li>
</ul>
<figure>
<img src="../pictures/20250522/image%2023.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>根据图示的测试结果，如果使用的是全局的<code>operator new/delete</code>时，则类与类之间的内存间隔就会多些，因为上下cookies的占用。</p>
<p>接下来，用代码测试这部分是否符合预期。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Airplane</span> &#123;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AirplaneRep</span> &#123;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> miles;<br>        <span class="hljs-type">char</span> type;<br>    &#125;;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-keyword">union</span> &#123;<br>        AirplaneRep rep; <span class="hljs-comment">// used object</span><br>        Airplane* next;  <span class="hljs-comment">// free list</span><br>    &#125;;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title">getMiles</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> rep.miles;&#125;<br>    <span class="hljs-function"><span class="hljs-type">char</span> <span class="hljs-title">getType</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> rep.type;&#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">set</span> <span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> m, <span class="hljs-type">char</span> t)</span> </span>&#123;<br>        rep.miles = m;<br>        rep.type = t;<br>    &#125;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* deadobject, <span class="hljs-type">size_t</span> size)</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> BLOCK_SIZZ;<br>    <span class="hljs-type">static</span> Airplane* headofFreeList;<br>&#125;;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> Airplane::BLOCK_SIZZ = <span class="hljs-number">512</span>;<br>Airplane* Airplane::headofFreeList = <span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// static类型的变量在类外定义时不能指定static类型</span><br><br><span class="hljs-function"><span class="hljs-type">void</span>* Airplane::<span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-comment">// 如果大小错误，交给 global operator new</span><br>    <span class="hljs-comment">// 在常规的情况下不会走到这里</span><br>    <span class="hljs-keyword">if</span> (size != <span class="hljs-built_in">sizeof</span>(Airplane)) &#123;<br>        <span class="hljs-keyword">return</span> ::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(size);<br>    &#125;<br>    Airplane* p = headofFreeList;<br>    <span class="hljs-comment">// if p 有效，就把free list往下一个移</span><br>    <span class="hljs-keyword">if</span> (p) &#123;<br>        headofFreeList = p-&gt;next;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// free list为空，要重新分配</span><br>        Airplane* newBlock = <span class="hljs-built_in">static_cast</span>&lt;Airplane*&gt;<br>            (::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(BLOCK_SIZZ * <span class="hljs-built_in">sizeof</span>(Airplane)));<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; BLOCK_SIZZ - <span class="hljs-number">1</span>; ++i) &#123;<br>            newBlock[i].next = &amp;newBlock[i + <span class="hljs-number">1</span>];  <br>        &#125;<br>        newBlock[BLOCK_SIZZ - <span class="hljs-number">1</span>].next = <span class="hljs-literal">nullptr</span>;<br><br>        <span class="hljs-comment">// 将p设置为头部，将headofFreeList设置为下一个可用的块</span><br>        p = newBlock;<br>        headofFreeList = &amp;newBlock[<span class="hljs-number">1</span>];<br>    &#125;<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> Airplane::<span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* deadobject, <span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (deadobject == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-keyword">if</span> (size != <span class="hljs-built_in">sizeof</span>(Airplane)) &#123;<br>        ::<span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(deadobject)</span></span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    Airplane *carcass = <span class="hljs-built_in">static_cast</span>&lt;Airplane*&gt;(deadobject);<br>    carcass-&gt;next = headofFreeList;<br>    headofFreeList = carcass;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;test per class allocator 2.....&quot;</span> &lt;&lt; endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;sizeof(Airplane) = &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(Airplane) &lt;&lt; endl;<br><br>    <span class="hljs-type">size_t</span> <span class="hljs-type">const</span> N = <span class="hljs-number">100</span>;<br>    Airplane* p[N];<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) &#123;<br>        p[i] = <span class="hljs-keyword">new</span> Airplane;<br>    &#125;<br>    <span class="hljs-comment">// 随机测试objec 正常否</span><br>    p[<span class="hljs-number">1</span>]-&gt;<span class="hljs-built_in">set</span>(<span class="hljs-number">10000</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>    p[<span class="hljs-number">4</span>]-&gt;<span class="hljs-built_in">set</span>(<span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>    p[<span class="hljs-number">9</span>]-&gt;<span class="hljs-built_in">set</span>(<span class="hljs-number">30000</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br>    cout &lt;&lt; p[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[<span class="hljs-number">1</span>]-&gt;<span class="hljs-built_in">getType</span>() &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[<span class="hljs-number">1</span>]-&gt;<span class="hljs-built_in">getMiles</span>() &lt;&lt; endl;<br>    cout &lt;&lt; p[<span class="hljs-number">4</span>] &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[<span class="hljs-number">4</span>]-&gt;<span class="hljs-built_in">getType</span>() &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[<span class="hljs-number">4</span>]-&gt;<span class="hljs-built_in">getMiles</span>() &lt;&lt; endl;<br>    cout &lt;&lt; p[<span class="hljs-number">9</span>] &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[<span class="hljs-number">9</span>]-&gt;<span class="hljs-built_in">getType</span>() &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[<span class="hljs-number">9</span>]-&gt;<span class="hljs-built_in">getMiles</span>() &lt;&lt; endl;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>        cout &lt;&lt; p[i] &lt;&lt; endl;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) &#123;<br>        <span class="hljs-keyword">delete</span> p[i];<br>    &#125;<br><br>    cout &lt;&lt; <span class="hljs-string">&quot;---------------------&quot;</span> &lt;&lt; endl;<br><br>    Airplane* p1[N];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i) &#123;<br>        p1[i] = <span class="hljs-built_in">static_cast</span>&lt;Airplane*&gt;(::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(<span class="hljs-built_in">sizeof</span>(Airplane)));<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>        cout &lt;&lt; p1[i] &lt;&lt; endl;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp">test per <span class="hljs-keyword">class</span> <span class="hljs-title class_">allocator</span> <span class="hljs-number">2.</span>....<br><span class="hljs-built_in">sizeof</span>(Airplane) = <span class="hljs-number">16</span><br><span class="hljs-number">0xaaaac59802d0</span> A <span class="hljs-number">10000</span><br><span class="hljs-number">0xaaaac5980300</span> B <span class="hljs-number">20000</span><br><span class="hljs-number">0xaaaac5980350</span> C <span class="hljs-number">30000</span><br><span class="hljs-number">0xaaaac59802c0</span><br><span class="hljs-number">0xaaaac59802d0</span><br><span class="hljs-number">0xaaaac59802e0</span><br><span class="hljs-number">0xaaaac59802f0</span><br><span class="hljs-number">0xaaaac5980300</span><br><span class="hljs-number">0xaaaac5980310</span><br><span class="hljs-number">0xaaaac5980320</span><br><span class="hljs-number">0xaaaac5980330</span><br><span class="hljs-number">0xaaaac5980340</span><br><span class="hljs-number">0xaaaac5980350</span><br>---------------------<br><span class="hljs-number">0xaaaac59822d0</span><br><span class="hljs-number">0xaaaac59822f0</span><br><span class="hljs-number">0xaaaac5982310</span><br><span class="hljs-number">0xaaaac5982330</span><br><span class="hljs-number">0xaaaac5982350</span><br><span class="hljs-number">0xaaaac5982370</span><br><span class="hljs-number">0xaaaac5982390</span><br><span class="hljs-number">0xaaaac59823b0</span><br><span class="hljs-number">0xaaaac59823d0</span><br><span class="hljs-number">0xaaaac59823f0</span><br></code></pre></td></tr></table></figure>
<p>根据输出结果来看，用全局的<code>operator new</code>时，类与类之间的间隔是32个字节，如果用我们自定义的<code>new</code>方法，可以加减少<code>cookies</code>的占用，从32个字节变成了16个字节。</p>
<h1 id="common-static-allocator-版本三">Common static allocator 版本三</h1>
<p>对每一个类写一个上述的operator new和operator delete的静态成员函数显得有些重复，我们可以将其包装起来，以便下次使用时可以直接调用。每个分配器都是一个对象，我们可以直接调用。</p>
<figure>
<img src="../pictures/20250522/image%2024.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2025.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2026.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<p>任然使用embeding Point的形式，类的大小是allocator传入的size_t，我们使用的size_t的前四个字节进行内存管理。具体代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">allocator_my</span> &#123;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">obj</span> &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">obj</span>* next;<br>    &#125;;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span>)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dealloacte</span><span class="hljs-params">(<span class="hljs-type">void</span>*, <span class="hljs-type">size_t</span>)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check</span><span class="hljs-params">()</span></span>;<br><span class="hljs-keyword">private</span>:<br>    obj* freestore&#123;<span class="hljs-literal">nullptr</span>&#125;;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> CHUNK = <span class="hljs-number">5</span>;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">allocator_my::allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">obj</span>* p;<br>    <span class="hljs-keyword">if</span> (!freestore) &#123;<br>        <span class="hljs-type">size_t</span> chunk = CHUNK * size;<br>        freestore = p = (obj*)<span class="hljs-built_in">malloc</span>(chunk);<br><br>        <span class="hljs-comment">// 分割好后，需要将链表串起来</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CHUNK - <span class="hljs-number">1</span>; ++i) &#123;<br>            p-&gt;next = (obj*)(((<span class="hljs-type">char</span>*)p) + size);<br>            p = p -&gt;next;<br>        &#125;<br>        p-&gt;next = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    p = freestore;<br>    freestore = freestore-&gt;next;<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">allocator_my::dealloacte</span><span class="hljs-params">(<span class="hljs-type">void</span>* p, <span class="hljs-type">size_t</span>)</span> </span>&#123;<br>    ((obj*)p)-&gt;next = freestore;<br>    freestore = (obj*)p;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">allocator_my::check</span><span class="hljs-params">()</span> </span>&#123;<br>    obj* p = freestore;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (p) &#123;<br>        cout &lt;&lt; p &lt;&lt; endl;<br>        p = p-&gt;next;<br>        count++;<br>    &#125;<br>    cout &lt;&lt; count &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">long</span> L;<br>    string str;<br>    <span class="hljs-type">static</span> allocator_my myAlloc;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Foo</span>(<span class="hljs-type">long</span> l) : <span class="hljs-built_in">L</span>(l) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> myAlloc.<span class="hljs-built_in">allocate</span>(size);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* pdead, <span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> myAlloc.<span class="hljs-built_in">dealloacte</span>(pdead, size);<br>    &#125;<br>&#125;;<br><br>allocator_my Foo::myAlloc;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Goo</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    complex&lt;<span class="hljs-type">double</span>&gt; c;<br>    string str;<br>    <span class="hljs-type">static</span> allocator_my myAlloc;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Goo</span>(<span class="hljs-type">const</span> complex&lt;<span class="hljs-type">double</span>&gt;&amp; x) : <span class="hljs-built_in">c</span>(x) &#123; &#125;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> myAlloc.<span class="hljs-built_in">allocate</span>(size);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span>* pdead, <span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> myAlloc.<span class="hljs-built_in">dealloacte</span>(pdead, size); <br>    &#125;<br>&#125;;<br><br>allocator_my Goo::myAlloc;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    &#123;<br>        Foo* p[<span class="hljs-number">100</span>];<br>        cout &lt;&lt; <span class="hljs-string">&quot;sizeof (Foo) = &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(Foo) &lt;&lt; endl;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">25</span>; ++i) &#123;<br>            p[i] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>(i);<br>            cout &lt;&lt; p[i] &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[i]-&gt;L &lt;&lt; endl;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">25</span>; ++i) &#123;<br>            <span class="hljs-keyword">delete</span> p[i];<br>        &#125;<br>        Foo::myAlloc.<span class="hljs-built_in">check</span>();<br>    &#125;<br>    cout &lt;&lt; <span class="hljs-string">&quot;----------------&quot;</span> &lt;&lt; endl;<br>    &#123;<br>        Goo* p[<span class="hljs-number">100</span>];<br>        cout &lt;&lt; <span class="hljs-string">&quot;sizeof(Goo) = &quot;</span> &lt;&lt; <span class="hljs-built_in">sizeof</span>(Goo) &lt;&lt; endl;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>            p[i] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Goo</span>(<span class="hljs-built_in">complex</span>&lt;<span class="hljs-type">double</span>&gt;(i, i));<br>            cout &lt;&lt; p[i] &lt;&lt; <span class="hljs-string">&#x27; &#x27;</span> &lt;&lt; p[i]-&gt;c &lt;&lt; endl;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>            <span class="hljs-keyword">delete</span> p[i];<br>        &#125;<br>        Goo::myAlloc.<span class="hljs-built_in">check</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs cpp">➜  mem ./<span class="hljs-function">jj09                 </span><br><span class="hljs-function"><span class="hljs-title">sizeof</span> <span class="hljs-params">(Foo)</span> </span>= <span class="hljs-number">40</span><br><span class="hljs-number">0xaaaaec5062c0</span> <span class="hljs-number">0</span><br><span class="hljs-number">0xaaaaec5062e8</span> <span class="hljs-number">1</span><br><span class="hljs-number">0xaaaaec506310</span> <span class="hljs-number">2</span><br><span class="hljs-number">0xaaaaec506338</span> <span class="hljs-number">3</span><br><span class="hljs-number">0xaaaaec506360</span> <span class="hljs-number">4</span><br><span class="hljs-number">0xaaaaec506390</span> <span class="hljs-number">5</span><br><span class="hljs-number">0xaaaaec5063b8</span> <span class="hljs-number">6</span><br><span class="hljs-number">0xaaaaec5063e0</span> <span class="hljs-number">7</span><br><span class="hljs-number">0xaaaaec506408</span> <span class="hljs-number">8</span><br><span class="hljs-number">0xaaaaec506430</span> <span class="hljs-number">9</span><br><span class="hljs-number">0xaaaaec506460</span> <span class="hljs-number">10</span><br><span class="hljs-number">0xaaaaec506488</span> <span class="hljs-number">11</span><br><span class="hljs-number">0xaaaaec5064b0</span> <span class="hljs-number">12</span><br><span class="hljs-number">0xaaaaec5064d8</span> <span class="hljs-number">13</span><br><span class="hljs-number">0xaaaaec506500</span> <span class="hljs-number">14</span><br><span class="hljs-number">0xaaaaec506530</span> <span class="hljs-number">15</span><br><span class="hljs-number">0xaaaaec506558</span> <span class="hljs-number">16</span><br><span class="hljs-number">0xaaaaec506580</span> <span class="hljs-number">17</span><br><span class="hljs-number">0xaaaaec5065a8</span> <span class="hljs-number">18</span><br><span class="hljs-number">0xaaaaec5065d0</span> <span class="hljs-number">19</span><br><span class="hljs-number">0xaaaaec506600</span> <span class="hljs-number">20</span><br><span class="hljs-number">0xaaaaec506628</span> <span class="hljs-number">21</span><br><span class="hljs-number">0xaaaaec506650</span> <span class="hljs-number">22</span><br><span class="hljs-number">0xaaaaec506678</span> <span class="hljs-number">23</span><br><span class="hljs-number">0xaaaaec5066a0</span> <span class="hljs-number">24</span><br><span class="hljs-number">0xaaaaec5066a0</span><br><span class="hljs-number">0xaaaaec506678</span><br><span class="hljs-number">0xaaaaec506650</span><br><span class="hljs-number">0xaaaaec506628</span><br><span class="hljs-number">0xaaaaec506600</span><br><span class="hljs-number">0xaaaaec5065d0</span><br><span class="hljs-number">0xaaaaec5065a8</span><br><span class="hljs-number">0xaaaaec506580</span><br><span class="hljs-number">0xaaaaec506558</span><br><span class="hljs-number">0xaaaaec506530</span><br><span class="hljs-number">0xaaaaec506500</span><br><span class="hljs-number">0xaaaaec5064d8</span><br><span class="hljs-number">0xaaaaec5064b0</span><br><span class="hljs-number">0xaaaaec506488</span><br><span class="hljs-number">0xaaaaec506460</span><br><span class="hljs-number">0xaaaaec506430</span><br><span class="hljs-number">0xaaaaec506408</span><br><span class="hljs-number">0xaaaaec5063e0</span><br><span class="hljs-number">0xaaaaec5063b8</span><br><span class="hljs-number">0xaaaaec506390</span><br><span class="hljs-number">0xaaaaec506360</span><br><span class="hljs-number">0xaaaaec506338</span><br><span class="hljs-number">0xaaaaec506310</span><br><span class="hljs-number">0xaaaaec5062e8</span><br><span class="hljs-number">0xaaaaec5062c0</span><br><span class="hljs-number">25</span><br>----------------<br><span class="hljs-built_in">sizeof</span>(Goo) = <span class="hljs-number">48</span><br><span class="hljs-number">0xaaaaec5066d0</span> (<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><span class="hljs-number">0xaaaaec506700</span> (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><span class="hljs-number">0xaaaaec506730</span> (<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br><span class="hljs-number">0xaaaaec506760</span> (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br><span class="hljs-number">0xaaaaec506790</span> (<span class="hljs-number">4</span>,<span class="hljs-number">4</span>)<br><span class="hljs-number">0xaaaaec5067d0</span> (<span class="hljs-number">5</span>,<span class="hljs-number">5</span>)<br><span class="hljs-number">0xaaaaec506800</span> (<span class="hljs-number">6</span>,<span class="hljs-number">6</span>)<br><span class="hljs-number">0xaaaaec506830</span> (<span class="hljs-number">7</span>,<span class="hljs-number">7</span>)<br><span class="hljs-number">0xaaaaec506860</span> (<span class="hljs-number">8</span>,<span class="hljs-number">8</span>)<br><span class="hljs-number">0xaaaaec506890</span> (<span class="hljs-number">9</span>,<span class="hljs-number">9</span>)<br><span class="hljs-number">0xaaaaec506890</span><br><span class="hljs-number">0xaaaaec506860</span><br><span class="hljs-number">0xaaaaec506830</span><br><span class="hljs-number">0xaaaaec506800</span><br><span class="hljs-number">0xaaaaec5067d0</span><br><span class="hljs-number">0xaaaaec506790</span><br><span class="hljs-number">0xaaaaec506760</span><br><span class="hljs-number">0xaaaaec506730</span><br><span class="hljs-number">0xaaaaec506700</span><br><span class="hljs-number">0xaaaaec5066d0</span><br></code></pre></td></tr></table></figure>
<h1 id="macro-allocator-版本四">Macro allocator 版本四</h1>
<p>既然上述的写法比较通用，我们可以将其抽象为宏，这样才后续的代码撰写中就可以轻松的写出类的分配器。</p>
<figure>
<img src="../pictures/20250522/image%2027.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure>
<img src="../pictures/20250522/image%2028.png" srcset="/img/loading.gif" lazyload alt="" /><figcaption>image.png</figcaption>
</figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//借鏡 MFC macros. </span><br><span class="hljs-comment">// DECLARE_POOL_ALLOC -- used in class definition</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DECLARE_POOL_ALLOC() \</span><br><span class="hljs-meta">public: \</span><br><span class="hljs-meta">    void* operator new(size_t size) &#123; return myAlloc.allocate(size); &#125; \</span><br><span class="hljs-meta">    void operator delete(void* p) &#123; myAlloc.deallocate(p, 0); &#125; \</span><br><span class="hljs-meta">protected: \</span><br><span class="hljs-meta">    static allocator myAlloc; </span><br><br><span class="hljs-comment">// IMPLEMENT_POOL_ALLOC -- used in class implementation file</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IMPLEMENT_POOL_ALLOC(class_name) \</span><br><span class="hljs-meta">allocator class_name::myAlloc; </span><br><br><span class="hljs-comment">// in class definition file</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> &#123;<br>   <span class="hljs-built_in">DECLARE_POOL_ALLOC</span>()<br><span class="hljs-keyword">public</span>: <br>    <span class="hljs-type">long</span> L;<br>    string str;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Foo</span>(<span class="hljs-type">long</span> l) : <span class="hljs-built_in">L</span>(l) &#123;  &#125;   <br>&#125;;<br><span class="hljs-comment">//in class implementation file</span><br><span class="hljs-built_in">IMPLEMENT_POOL_ALLOC</span>(Foo) <br><br><span class="hljs-comment">//  in class definition file</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Goo</span> &#123;<br>   <span class="hljs-built_in">DECLARE_POOL_ALLOC</span>()<br><span class="hljs-keyword">public</span>: <br>    complex&lt;<span class="hljs-type">double</span>&gt; c;<br>    string str;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Goo</span>(<span class="hljs-type">const</span> complex&lt;<span class="hljs-type">double</span>&gt;&amp; x) : <span class="hljs-built_in">c</span>(x) &#123;  &#125;   <br>&#125;;<br><span class="hljs-comment">//in class implementation file</span><br><span class="hljs-built_in">IMPLEMENT_POOL_ALLOC</span>(Goo) <br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/" class="category-chain-item">课程学习</a>
  
  
    <span>></span>
    
  <a href="/categories/%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E4%BE%AF%E6%8D%B7/" class="category-chain-item">内存管理-侯捷</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/C/" class="print-no-link">#C++</a>
      
        <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="print-no-link">#基础知识</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>内存原语</div>
      <div>https://csningg.github.io/posts/572525303/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>zningg</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年5月22日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/1398903302/" title="std::allocate解析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">std::allocate解析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/2554354592/" title="第七章：站在对象模型的尖端">
                        <span class="hidden-mobile">第七章：站在对象模型的尖端</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"csningg/comment","repo-id":"R_kgDOOvyAGA","category":"General","category-id":"DIC_kwDOOvyAGM4Cqinz","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"bottom","lang":"zh-CN"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <div>
    <span id="timeDate">正在载入天数...</span>
    <span id="times">载入时分秒...</span>
    <script>
    var now = new Date();
    function createtime(){
        var grt= new Date("03/08/2025 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24;
        dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){
            hnum = "0" + hnum;
        }
        minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if(String(mnum).length ==1 ){
                  mnum = "0" + mnum;
        }
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if(String(snum).length ==1 ){
                  snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = "🚀已持续航行&nbsp"+dnum+"&nbsp天";  
        document.getElementById("times").innerHTML = hnum + "&nbsp时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
    }
    setInterval("createtime()",250);
    </script>
  </div>

  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
